# Sina Finance API 文档

本文档描述了本项目 (`src/api.rs` 和 `src/models.rs`) 如何与新浪财经接口进行交互，以获取中国 A 股市场的实时行情和 K 线数据。

## 1. 简介 (Introduction)

本项目封装了新浪财经 (Sina Finance) 的公开 HTTP 接口。主要功能包括：
- **实时行情**: 获取股票的最新价格、涨跌幅、成交量等信息。
- **K 线数据**: 获取不同周期（分钟、日、周、月）的历史行情数据。

由于新浪接口返回的数据编码可能为 GBK，本模块内部已处理编码转换（GBK -> UTF-8）。

## 2. 外部接口说明 (External API Endpoints)

以下是本项目底层调用的新浪财经接口详情。

### 2.1 实时行情接口 (Real-time Quote)

*   **URL**: `http://hq.sinajs.cn/list=[股票代码]`
*   **Method**: `GET`
*   **Headers**:
    *   `Referer`: `http://finance.sina.com.cn` (必须带上，否则可能被防盗链拦截)
*   **Response Format**: `GBK` 编码的文本，内容为 JavaScript 变量赋值语句。
*   **示例**:
    ```text
    var hq_str_sh600519="贵州茅台,1731.500,1732.000,1755.000,1760.000,1728.000,1754.980,1755.000,25432100,44539876543.000,100,1754.980,200,1754.970,300,1754.960,400,1754.950,500,1754.940,100,1755.000,200,1755.010,300,1755.020,400,1755.030,500,1755.040,2025-02-11,15:00:00,00,";
    ```
    *字段含义参考 `src/api.rs` 中的 `parse_realtime_quote` 函数实现。*

### 2.2 K 线数据接口 (Candlestick Data)

*   **URL**: `http://money.finance.sina.com.cn/quotes_service/api/json_v2.php/CN_MarketData.getKLineData`
*   **Method**: `GET`
*   **Parameters**:
    *   `symbol`: 股票代码 (例如 `sh600519`)
    *   `scale`: 时间周期 (单位：分钟)
        *   `5`: 5分钟
        *   `15`: 15分钟
        *   `30`: 30分钟
        *   `60`: 60分钟
        *   `240`: 日K
        *   `1200`: 周K
        *   `7200`: 月K
    *   `ma`: 均线 (本项目固定为 `no`)
    *   `datalen`: 请求的数据长度 (例如 `1023`)
*   **Response Format**: JSON 数组。
*   **示例**:
    ```json
    [
        {
            "day": "2025-02-11",
            "open": "1731.500",
            "high": "1760.000",
            "low": "1728.000",
            "close": "1755.000",
            "volume": "25432100"
        },
        ...
    ]
    ```

## 3. Rust API 模块 (`src/api.rs`)

本模块提供了强类型的 Rust 函数来调用上述接口。

### 3.1 获取单只股票实时行情

```rust
pub fn fetch_realtime_quote(symbol: &str) -> Result<StockQuote>
```
*   **参数**: `symbol` - 股票代码 (如 `"sh600519"`, `"sz000001"`).
*   **返回**: `Result<StockQuote>` - 解析后的行情结构体或错误。
*   **说明**: 内部会自动处理 GBK 解码和字段解析。

### 3.2 批量获取实时行情

```rust
pub fn fetch_multiple_quotes(symbols: &[String]) -> Vec<Result<StockQuote>>
```
*   **参数**: `symbols` - 股票代码列表。
*   **返回**: 包含每个请求结果的 `Vec`。
*   **说明**: 目前实现为顺序请求。

### 3.3 获取 K 线数据

```rust
pub fn fetch_kline_data(symbol: &str, scale: u32, datalen: u32) -> Result<Vec<KLineData>>
```
*   **参数**:
    *   `symbol`: 股票代码。
    *   `scale`: 周期 (建议使用 `TimeFrame::scale()` 获取)。
    *   `datalen`: 获取的 K 线数量。
*   **返回**: `Result<Vec<KLineData>>` - K 线数据列表。

## 4. 数据模型 (`src/models.rs`)

### 4.1 `StockQuote` (实时行情)

| 字段 | 类型 | 描述 |
| :--- | :--- | :--- |
| `name` | `String` | 股票名称 |
| `symbol` | `String` | 股票代码 |
| `open` | `f64` | 今日开盘价 |
| `pre_close` | `f64` | 昨日收盘价 |
| `current` | `f64` | 当前价格 |
| `high` | `f64` | 今日最高价 |
| `low` | `f64` | 今日最低价 |
| `volume` | `f64` | 成交量 (股) |
| `turnover` | `f64` | 成交额 (元) |
| `date` | `String` | 日期 |
| `time` | `String` | 时间 |

*提供辅助方法:*
*   `change()`: 涨跌额
*   `change_percent()`: 涨跌幅 (%)
*   `volume_display()`: 格式化成交量 (万手/手)
*   `turnover_display()`: 格式化成交额 (亿/万/元)

### 4.2 `KLineData` (K线数据)

| 字段 | 类型 | 描述 |
| :--- | :--- | :--- |
| `day` | `String` | 日期/时间字符串 |
| `open` | `String` | 开盘价 (原始字符串) |
| `high` | `String` | 最高价 (原始字符串) |
| `low` | `String` | 最低价 (原始字符串) |
| `close` | `String` | 收盘价 (原始字符串) |
| `volume` | `String` | 成交量 (原始字符串) |

*注意: 原始 JSON 字段均为字符串，`KLineData` 提供了 `open_f64()`, `close_f64()` 等辅助方法进行数值转换。*

### 4.3 `TimeFrame` (周期枚举)

枚举值对应不同的 K 线周期，提供了 `scale()` 方法转换为 API 所需的参数。

*   `Min5` (5分钟)
*   `Min15` (15分钟)
*   `Min30` (30分钟)
*   `Min60` (60分钟)
*   `Daily` (日线)
*   `Weekly` (周线)
*   `Monthly` (月线)

## 5. 错误处理

API 调用使用了 `anyhow::Result` 进行错误传递。常见的错误原因包括：
*   网络请求失败 (超时、DNS 解析错误等)。
*   股票代码无效或未找到。
*   API 响应格式变化导致解析失败。
*   GBK 解码失败。

---
Generated by Gemini CLI
